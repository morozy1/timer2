<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>den · таймер + статистика</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
height:100vh;display:flex;justify-content:center;align-items:center;
font-family:'Inter',sans-serif;color:white;
background:#1a1a1a;
}
/* Фиксированная навигация */
.top-nav{
position:fixed;
top:20px;
left:0;
right:0;
display:flex;
justify-content:center;
gap:20px;
z-index:1000;
}
.top-nav button{
background:#2d2d2d;
border:1px solid #404040;
padding:12px 32px;border-radius:40px;color:white;cursor:pointer;
font-weight:600;font-size:16px;transition:0.2s;
}
.top-nav button:hover{background:#404040;}
/* Контейнер с отступом сверху, чтобы не прятаться под навигацию */
.container{
width:1100px;
padding-top:80px; /* чтобы контент начинался ниже кнопок */
}
.card{
background:transparent;
border:none;
padding:40px;border-radius:48px;
display:flex;flex-direction:column;
align-items:center;gap:30px;
}
h2, h3{width:100%;text-align:left;font-weight:500;color:#e0e0e0;}
h2{font-size:24px;margin-bottom:5px;}
h3{font-size:18px;margin-bottom:10px;color:#b0b0b0;}
select,input,button{padding:12px 20px;border-radius:30px;border:none;outline:none;font-size:16px;}
.primary{
background:#a3e635;
color:#1a1a1a;
font-weight:600;
}
.primary:hover{background:#b8ff4d;}
.danger{background:#dc2626;color:white;}
.secondary{background:#404040;color:white;}
.secondary:hover{background:#525252;}
.hidden{display:none !important}

/* Таймер */
#currentActivity{
font-size:32px;font-weight:600;color:#a3e635;text-align:center;
}
#countdown{
font-size:80px;text-align:center;font-weight:700;letter-spacing:5px;color:#a3e635;
}
.progress{height:8px;background:#404040;border-radius:20px;overflow:hidden;width:100%;}
.progress-bar{height:100%;width:0%;background:#a3e635;transition:width 1s linear;}
.activity-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}

/* Кнопки активностей */
.activity-btn{
background:#404040;color:white;padding:10px 20px;border-radius:30px;
cursor:pointer;transition:0.2s;border:2px solid transparent;
}
.activity-btn:hover{background:#525252;}
.activity-btn.active{
border-color:#a3e635;
background:#2d2d2d;
}

/* Барабаны */
.picker-container{
display:flex;gap:40px;justify-content:center;align-items:center;
}
.picker{
display:flex;flex-direction:column;align-items:center;gap:8px;
}
.picker label{font-size:14px;color:#b0b0b0;text-transform:uppercase;letter-spacing:1px;}
.picker-value{
background:#404040;border-radius:30px;padding:15px 30px;
font-size:40px;font-weight:700;color:#a3e635;
cursor:ns-resize;user-select:none;transition:0.1s;
border:2px solid transparent;
}
.picker-value:hover{border-color:#a3e635;}

/* Добавление категории */
.add-category{
display:flex;gap:10px;width:100%;
}
.add-category input{flex:2;background:#404040;color:white;}
.add-category input::placeholder{color:#b0b0b0;}

/* Статистика */
.stats-grid{
display:flex;flex-direction:column;gap:25px;width:100%;
}
.stats-card{
background:#404040;border-radius:30px;padding:25px;
}
.stats-card h3{margin-bottom:15px;color:#e0e0e0;}
.stats-table{width:100%;border-collapse:collapse;}
.stats-table td{padding:10px 0;border-bottom:1px solid #525252;}
.stats-table tr:last-child td{border-bottom:none;}
.chart-container{
width:100%;height:250px;margin-top:10px;
}
</style>
</head>
<body>

<div class="container">

<div class="top-nav">
<button onclick="showTimer()">Timer</button>
<button onclick="showStats()">Statistics</button>
</div>

<!-- TIMER -->
<div id="timerScreen">
<div class="card">

    <!-- Секция выбора активности (кнопки) -->
    <div id="activitySelection" style="width:100%;">
        <h3>Activity</h3>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div id="activityButtons" class="activity-row" style="justify-content: flex-start;"></div>
            <div class="add-category">
                <input type="text" id="newCategoryInput" placeholder="New category name">
                <button class="secondary" onclick="addCategory()">Add</button>
                <button class="danger" onclick="deleteCategory()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Быстрые кнопки -->
    <div id="quickButtons" style="width:100%;">
        <h3>Quick select</h3>
        <div class="activity-row">
            <button class="secondary" onclick="startQuick(15)">15 min</button>
            <button class="secondary" onclick="startQuick(30)">30 min</button>
            <button class="secondary" onclick="startQuick(60)">1 hour</button>
            <button class="secondary" onclick="startQuick(120)">2 hours</button>
        </div>
    </div>

    <!-- Барабаны (колёсико) -->
    <div id="customPicker" style="width:100%;">
        <h3>Custom time</h3>
        <div class="picker-container">
            <div class="picker">
                <label>Hours</label>
                <div class="picker-value" id="hoursValue">0</div>
            </div>
            <div class="picker">
                <label>Minutes</label>
                <div class="picker-value" id="minutesValue">0</div>
            </div>
        </div>
        <div class="activity-row" style="margin-top:20px;">
            <button class="primary" onclick="startCustom()">Start Session</button>
        </div>
    </div>

    <!-- Элементы таймера (скрыты до запуска) -->
    <div id="timerActiveArea" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center; gap:15px;">
        <div id="currentActivity"></div>
        <div id="countdown">00:00</div>
        <div class="progress" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="runningButtons" class="activity-row">
            <button class="secondary" onclick="finishEarly()">Finish Early</button>
            <button class="danger" onclick="cancelTimer()">Cancel</button>
        </div>
    </div>

</div>
</div>

<!-- STATISTICS -->
<div id="statsScreen" class="hidden">
<div class="card">
    <h2>Statistics</h2>
    <div class="stats-grid">
        <!-- Сегодня -->
        <div class="stats-card" id="todayStats">
            <h3>Today</h3>
            <table class="stats-table" id="todayTable"></table>
        </div>
        <!-- Последние 7 дней по активностям (таблица) -->
        <div class="stats-card" id="weekActivityStats">
            <h3>Last 7 days (by activity)</h3>
            <table class="stats-table" id="weekActivityTable"></table>
        </div>
        <!-- Линейный график по дням за 7 дней -->
        <div class="stats-card" id="weekChartStats">
            <h3>Last 7 days (activity trends)</h3>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>
</div>
</div>

</div>

<script>
let activities = JSON.parse(localStorage.getItem("activities")) || ["General"];
let sessions = JSON.parse(localStorage.getItem("sessions")) || [];
let targetDate, startTime, interval, totalDuration;

let selectedActivity = "General";

const hoursDiv = document.getElementById("hoursValue");
const minutesDiv = document.getElementById("minutesValue");
const activityButtonsDiv = document.getElementById("activityButtons");
let hours = 0, minutes = 0;
let chartInstance = null;

// ---- Функции сохранения/восстановления состояния таймера ----
function saveTimerState() {
    if (targetDate) {
        const state = {
            targetDate: targetDate.getTime(),
            totalDuration: totalDuration,
            selectedActivity: selectedActivity,
            startTime: startTime ? startTime.getTime() : null
        };
        localStorage.setItem("timerState", JSON.stringify(state));
    }
}

function clearTimerState() {
    localStorage.removeItem("timerState");
}

function restoreTimerState() {
    const saved = localStorage.getItem("timerState");
    if (!saved) return false;

    try {
        const state = JSON.parse(saved);
        const now = Date.now();
        if (state.targetDate > now) {
            targetDate = new Date(state.targetDate);
            totalDuration = state.totalDuration;
            selectedActivity = state.selectedActivity;
            startTime = state.startTime ? new Date(state.startTime) : new Date(now - (totalDuration - (targetDate - now)));

            loadActivities();
            showTimer();
            launch(true);
            return true;
        } else {
            completeSession(state.totalDuration);
            clearTimerState();
            return false;
        }
    } catch (e) {
        console.error("Failed to restore timer state", e);
        clearTimerState();
        return false;
    }
}

function saveActivities() { localStorage.setItem("activities", JSON.stringify(activities)); }
function saveSessions() { localStorage.setItem("sessions", JSON.stringify(sessions)); }

function loadActivities() {
    activityButtonsDiv.innerHTML = "";
    activities.forEach(act => {
        let btn = document.createElement("button");
        btn.className = "activity-btn";
        if (act === selectedActivity) btn.classList.add("active");
        btn.textContent = act;
        btn.onclick = () => {
            selectedActivity = act;
            document.querySelectorAll(".activity-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        };
        activityButtonsDiv.appendChild(btn);
    });
}

function addCategory() {
    const input = document.getElementById("newCategoryInput");
    const name = input.value.trim();
    if (!name) return;
    if (!activities.includes(name)) {
        activities.push(name);
        saveActivities();
        loadActivities();
        input.value = "";
        selectedActivity = name;
        loadActivities();
    } else alert("Category already exists");
}

function deleteCategory() {
    if (selectedActivity === "General") { alert("General cannot be deleted."); return; }
    activities = activities.filter(a => a !== selectedActivity);
    saveActivities();
    selectedActivity = "General";
    loadActivities();
}

// Управление колёсиком
function setupWheel(element, min, max, callback) {
    element.addEventListener('wheel', (e) => {
        e.preventDefault();
        let delta = e.deltaY > 0 ? -1 : 1;
        let newVal = parseInt(element.innerText) + delta;
        if (newVal < min) newVal = max;
        if (newVal > max) newVal = min;
        element.innerText = newVal;
        callback(newVal);
    });
}

setupWheel(hoursDiv, 0, 23, (val) => hours = val);
setupWheel(minutesDiv, 0, 59, (val) => minutes = val);

function startQuick(minutesTotal) {
    startTimerWithMinutes(minutesTotal);
}

function startCustom() {
    let totalMinutes = hours * 60 + minutes;
    if (totalMinutes <= 0) { alert("Select time > 0"); return; }
    startTimerWithMinutes(totalMinutes);
}

function startTimerWithMinutes(minutes) {
    clearInterval(interval);
    const now = new Date();
    startTime = now;
    targetDate = new Date(now.getTime() + minutes * 60000);
    totalDuration = targetDate - now;
    launch();
    saveTimerState();
}

function launch(isRestore = false) {
    document.getElementById("activitySelection").classList.add("hidden");
    document.getElementById("quickButtons").classList.add("hidden");
    document.getElementById("customPicker").classList.add("hidden");
    
    const timerArea = document.getElementById("timerActiveArea");
    timerArea.classList.remove("hidden");
    document.getElementById("currentActivity").textContent = selectedActivity;
    
    if (!isRestore) {
        update();
        interval = setInterval(update, 1000);
    } else {
        update();
        interval = setInterval(update, 1000);
    }
}

function update() {
    const now = new Date();
    const diff = targetDate - now;
    if (diff <= 0) { 
        completeSession(totalDuration); 
        return; 
    }
    const percent = ((totalDuration - diff) / totalDuration) * 100;
    document.getElementById("progressBar").style.width = percent + "%";
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    document.getElementById("countdown").textContent =
        String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');
    
    saveTimerState();
}

function completeSession(duration) {
    clearInterval(interval);
    const activity = selectedActivity;
    sessions.push({
        activity: activity,
        duration: duration,
        date: new Date().toISOString().split("T")[0],
        timestamp: Date.now()
    });
    saveSessions();
    clearTimerState();
    resetUI();
    renderStats();
}

function finishEarly() {
    clearInterval(interval);
    const duration = new Date() - startTime;
    completeSession(duration);
}

function cancelTimer() {
    clearInterval(interval);
    clearTimerState();
    resetUI();
}

function resetUI() {
    document.getElementById("activitySelection").classList.remove("hidden");
    document.getElementById("quickButtons").classList.remove("hidden");
    document.getElementById("customPicker").classList.remove("hidden");
    
    document.getElementById("timerActiveArea").classList.add("hidden");
    document.getElementById("progressBar").style.width = "0%";
    document.getElementById("countdown").textContent = "00:00";
}

function showTimer() {
    document.getElementById("timerScreen").classList.remove("hidden");
    document.getElementById("statsScreen").classList.add("hidden");
}

function showStats() {
    document.getElementById("timerScreen").classList.add("hidden");
    document.getElementById("statsScreen").classList.remove("hidden");
    renderStats();
}

// ---------- СТАТИСТИКА ----------
function renderStats() {
    const today = new Date().toISOString().split('T')[0];
    const oneWeekAgo = Date.now() - 7*24*60*60*1000;

    // 1. Today
    const todaySessions = sessions.filter(s => s.date === today);
    const todayMap = new Map();
    todaySessions.forEach(s => {
        const act = s.activity;
        const mins = s.duration / 60000;
        todayMap.set(act, (todayMap.get(act) || 0) + mins);
    });
    let todayHtml = '';
    for (let [act, mins] of todayMap) {
        todayHtml += `<tr><td>${act}</td><td>${Math.round(mins)} min</td></tr>`;
    }
    if (todayHtml === '') todayHtml = '<tr><td colspan="2">No activity today</td></tr>';
    document.getElementById('todayTable').innerHTML = todayHtml;

    // 2. Last 7 days by activity
    const weekSessions = sessions.filter(s => s.timestamp >= oneWeekAgo);
    const weekMap = new Map();
    weekSessions.forEach(s => {
        const act = s.activity;
        const mins = s.duration / 60000;
        weekMap.set(act, (weekMap.get(act) || 0) + mins);
    });
    let weekHtml = '';
    for (let [act, mins] of weekMap) {
        weekHtml += `<tr><td>${act}</td><td>${Math.round(mins)} min</td></tr>`;
    }
    if (weekHtml === '') weekHtml = '<tr><td colspan="2">No activity last 7 days</td></tr>';
    document.getElementById('weekActivityTable').innerHTML = weekHtml;

    // 3. Линейный график
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
        days.push(d.toISOString().split('T')[0]);
    }

    const uniqueActivities = [...new Set(weekSessions.map(s => s.activity))];
    if (uniqueActivities.length === 0) {
        if (chartInstance) chartInstance.destroy();
        const ctx = document.getElementById('activityChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: days.map(d => d.slice(5)), datasets: [] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        return;
    }

    const datasets = [];
    const colors = ['#a3e635', '#60a5fa', '#f87171', '#fbbf24', '#c084fc', '#34d399', '#f472b6'];
    uniqueActivities.forEach((act, idx) => {
        const data = days.map(date => {
            const daySessions = sessions.filter(s => s.date === date && s.activity === act);
            const totalMin = daySessions.reduce((acc, s) => acc + s.duration, 0) / 60000;
            return Math.round(totalMin * 10) / 10;
        });
        datasets.push({
            label: act,
            data: data,
            borderColor: colors[idx % colors.length],
            backgroundColor: 'transparent',
            tension: 0.3,
            pointBackgroundColor: colors[idx % colors.length],
            borderWidth: 3
        });
    });

    if (chartInstance) chartInstance.destroy();

    const ctx = document.getElementById('activityChart').getContext('2d');
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: days.map(d => d.slice(5)),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'minutes', color: '#b0b0b0' },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: '#404040' }
                },
                x: {
                    ticks: { color: '#b0b0b0' },
                    grid: { color: '#404040' }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#e0e0e0',
                        usePointStyle: true,
                        pointStyle: 'circle',
                        boxWidth: 4,
                        boxHeight: 4,
                        font: { size: 10 }
                    }
                }
            }
        }
    });
}

// Инициализация
loadActivities();
renderStats();

if (!restoreTimerState()) {
    resetUI();
}
</script>
</body>
</html>

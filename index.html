<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>den · таймер + статистика</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
height:100vh;display:flex;justify-content:center;align-items:center;
font-family:'Inter',sans-serif;color:white;
background:#1a1a1a; /* основной тёмно-серый */
}
.container{width:1100px}
.top-nav{
display:flex;justify-content:center;gap:20px;margin-bottom:20px;
}
.top-nav button{
background:#2d2d2d;
border:1px solid #404040;
padding:12px 32px;border-radius:40px;color:white;cursor:pointer;
font-weight:600;font-size:16px;transition:0.2s;
}
.top-nav button:hover{background:#404040;}
.card{
background:transparent; /* прозрачный фон */
border:none; /* убрана обводка */
padding:40px;border-radius:48px;
display:flex;flex-direction:column;
align-items:center;gap:30px;
}
h2, h3{width:100%;text-align:left;font-weight:500;color:#e0e0e0;}
h2{font-size:24px;margin-bottom:5px;}
h3{font-size:18px;margin-bottom:10px;color:#b0b0b0;}
select,input,button{padding:12px 20px;border-radius:30px;border:none;outline:none;font-size:16px;}
.primary{
background:#a3e635;
color:#1a1a1a;
font-weight:600;
}
.primary:hover{background:#b8ff4d;}
.danger{background:#dc2626;color:white;}
.secondary{background:#404040;color:white;}
.secondary:hover{background:#525252;}
.hidden{display:none !important}
#countdown{font-size:80px;text-align:center;font-weight:700;letter-spacing:5px;color:#a3e635;}
.progress{height:8px;background:#404040;border-radius:20px;overflow:hidden;width:100%;}
.progress-bar{height:100%;width:0%;background:#a3e635;transition:width 1s linear;}
.activity-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}

/* Кнопки активностей */
.activity-btn{
background:#404040;color:white;padding:10px 20px;border-radius:30px;
cursor:pointer;transition:0.2s;border:2px solid transparent;
}
.activity-btn:hover{background:#525252;}
.activity-btn.active{
border-color:#a3e635; /* салатовая обводка для выбранной активности */
background:#2d2d2d;
}

/* Барабаны (без стрелок, только колёсико) */
.picker-container{
display:flex;gap:40px;justify-content:center;align-items:center;
}
.picker{
display:flex;flex-direction:column;align-items:center;gap:8px;
}
.picker label{font-size:14px;color:#b0b0b0;text-transform:uppercase;letter-spacing:1px;}
.picker-value{
background:#404040;border-radius:30px;padding:15px 30px;
font-size:40px;font-weight:700;color:#a3e635;
cursor:ns-resize;user-select:none;transition:0.1s;
border:2px solid transparent;
}
.picker-value:hover{border-color:#a3e635;}

/* Добавление категории */
.add-category{
display:flex;gap:10px;width:100%;
}
.add-category input{flex:2;background:#404040;color:white;}
.add-category input::placeholder{color:#b0b0b0;}

/* Статистика */
.stats-grid{
display:flex;flex-direction:column;gap:25px;width:100%;
}
.stats-card{
background:#404040;border-radius:30px;padding:25px;
}
.stats-card h3{margin-bottom:15px;color:#e0e0e0;}
.stats-table{width:100%;border-collapse:collapse;}
.stats-table td{padding:10px 0;border-bottom:1px solid #525252;}
.stats-table tr:last-child td{border-bottom:none;}
.chart{
display:flex;align-items:flex-end;gap:10px;height:150px;margin-top:15px;
}
.chart-bar{
flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;
}
.bar{
width:100%;background:#a3e635;border-radius:12px 12px 0 0;
transition:height 0.3s;
}
.bar-label{font-size:12px;color:#b0b0b0;}
</style>
</head>
<body>

<div class="container">

<div class="top-nav">
<button onclick="showTimer()">Timer</button>
<button onclick="showStats()">Statistics</button>
</div>

<!-- TIMER -->
<div id="timerScreen">
<div class="card">

    <!-- Секция выбора активности (теперь кнопки) -->
    <div id="activitySelection" style="width:100%;">
        <h3>Activity</h3>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div id="activityButtons" class="activity-row" style="justify-content: flex-start;"></div>
            <div class="add-category">
                <input type="text" id="newCategoryInput" placeholder="New category name">
                <button class="secondary" onclick="addCategory()">Add</button>
                <button class="danger" onclick="deleteCategory()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Быстрые кнопки -->
    <div id="quickButtons" style="width:100%;">
        <h3>Quick select</h3>
        <div class="activity-row">
            <button class="secondary" onclick="startQuick(15)">15 min</button>
            <button class="secondary" onclick="startQuick(30)">30 min</button>
            <button class="secondary" onclick="startQuick(60)">1 hour</button>
            <button class="secondary" onclick="startQuick(120)">2 hours</button>
        </div>
    </div>

    <!-- Барабаны (колёсико) -->
    <div id="customPicker" style="width:100%;">
        <h3>Custom time</h3>
        <div class="picker-container">
            <div class="picker">
                <label>Hours</label>
                <div class="picker-value" id="hoursValue">0</div>
            </div>
            <div class="picker">
                <label>Minutes</label>
                <div class="picker-value" id="minutesValue">0</div>
            </div>
        </div>
        <div class="activity-row" style="margin-top:20px;">
            <button class="primary" onclick="startCustom()">Start Session</button>
        </div>
    </div>

    <!-- Элементы таймера (скрыты до запуска) -->
    <div id="countdown" class="hidden">00:00</div>
    <div class="progress hidden" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="runningButtons" class="hidden activity-row">
        <button class="secondary" onclick="finishEarly()">Finish Early</button>
        <button class="danger" onclick="cancelTimer()">Cancel</button>
    </div>

</div>
</div>

<!-- STATISTICS -->
<div id="statsScreen" class="hidden">
<div class="card">
    <h2>Statistics</h2>
    <div class="stats-grid">
        <!-- Сегодня -->
        <div class="stats-card" id="todayStats">
            <h3>Today</h3>
            <table class="stats-table" id="todayTable"></table>
        </div>
        <!-- Последние 7 дней по активностям -->
        <div class="stats-card" id="weekActivityStats">
            <h3>Last 7 days (by activity)</h3>
            <table class="stats-table" id="weekActivityTable"></table>
        </div>
        <!-- График по дням за 7 дней -->
        <div class="stats-card" id="weekChartStats">
            <h3>Last 7 days (chart)</h3>
            <div class="chart" id="weekChart"></div>
        </div>
    </div>
</div>
</div>

</div>

<script>
let activities = JSON.parse(localStorage.getItem("activities")) || ["General"];
let sessions = JSON.parse(localStorage.getItem("sessions")) || [];
let targetDate, startTime, interval, totalDuration;

let selectedActivity = "General"; // по умолчанию

const hoursDiv = document.getElementById("hoursValue");
const minutesDiv = document.getElementById("minutesValue");
const activityButtonsDiv = document.getElementById("activityButtons");
let hours = 0, minutes = 0;

function saveActivities() { localStorage.setItem("activities", JSON.stringify(activities)); }
function saveSessions() { localStorage.setItem("sessions", JSON.stringify(sessions)); }

// Загрузка активностей в виде кнопок
function loadActivities() {
    activityButtonsDiv.innerHTML = "";
    activities.forEach(act => {
        let btn = document.createElement("button");
        btn.className = "activity-btn";
        if (act === selectedActivity) btn.classList.add("active");
        btn.textContent = act;
        btn.onclick = () => {
            selectedActivity = act;
            // обновить классы у всех кнопок
            document.querySelectorAll(".activity-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        };
        activityButtonsDiv.appendChild(btn);
    });
}

function addCategory() {
    const input = document.getElementById("newCategoryInput");
    const name = input.value.trim();
    if (!name) return;
    if (!activities.includes(name)) {
        activities.push(name);
        saveActivities();
        loadActivities();
        input.value = "";
        // автоматически выбрать новую активность?
        selectedActivity = name;
        loadActivities(); // перезагрузит с выделением
    } else alert("Category already exists");
}

function deleteCategory() {
    if (selectedActivity === "General") { alert("General cannot be deleted."); return; }
    activities = activities.filter(a => a !== selectedActivity);
    saveActivities();
    selectedActivity = "General";
    loadActivities();
}

// Управление колёсиком
function setupWheel(element, min, max, callback) {
    element.addEventListener('wheel', (e) => {
        e.preventDefault();
        let delta = e.deltaY > 0 ? -1 : 1;
        let newVal = parseInt(element.innerText) + delta;
        if (newVal < min) newVal = max;
        if (newVal > max) newVal = min;
        element.innerText = newVal;
        callback(newVal);
    });
}

setupWheel(hoursDiv, 0, 23, (val) => hours = val);
setupWheel(minutesDiv, 0, 59, (val) => minutes = val);

function startQuick(minutesTotal) {
    startTimerWithMinutes(minutesTotal);
}

function startCustom() {
    let totalMinutes = hours * 60 + minutes;
    if (totalMinutes <= 0) { alert("Select time > 0"); return; }
    startTimerWithMinutes(totalMinutes);
}

function startTimerWithMinutes(minutes) {
    clearInterval(interval);
    const now = new Date();
    startTime = now;
    targetDate = new Date(now.getTime() + minutes * 60000);
    totalDuration = targetDate - now;
    launch();
}

function launch() {
    document.getElementById("activitySelection").classList.add("hidden");
    document.getElementById("quickButtons").classList.add("hidden");
    document.getElementById("customPicker").classList.add("hidden");
    
    document.getElementById("countdown").classList.remove("hidden");
    document.getElementById("progressContainer").classList.remove("hidden");
    document.getElementById("runningButtons").classList.remove("hidden");
    
    update();
    interval = setInterval(update, 1000);
}

function update() {
    const now = new Date();
    const diff = targetDate - now;
    if (diff <= 0) { completeSession(totalDuration); return; }
    const percent = ((totalDuration - diff) / totalDuration) * 100;
    document.getElementById("progressBar").style.width = percent + "%";
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    document.getElementById("countdown").textContent =
        String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');
}

function completeSession(duration) {
    clearInterval(interval);
    const activity = selectedActivity;
    sessions.push({
        activity: activity,
        duration: duration,
        date: new Date().toISOString().split("T")[0],
        timestamp: Date.now()
    });
    saveSessions();
    resetUI();
    renderStats();
}

function finishEarly() {
    clearInterval(interval);
    const duration = new Date() - startTime;
    completeSession(duration);
}

function cancelTimer() {
    clearInterval(interval);
    resetUI();
}

function resetUI() {
    document.getElementById("activitySelection").classList.remove("hidden");
    document.getElementById("quickButtons").classList.remove("hidden");
    document.getElementById("customPicker").classList.remove("hidden");
    
    document.getElementById("countdown").classList.add("hidden");
    document.getElementById("progressContainer").classList.add("hidden");
    document.getElementById("runningButtons").classList.add("hidden");
    document.getElementById("progressBar").style.width = "0%";
}

function showTimer() {
    document.getElementById("timerScreen").classList.remove("hidden");
    document.getElementById("statsScreen").classList.add("hidden");
}

function showStats() {
    document.getElementById("timerScreen").classList.add("hidden");
    document.getElementById("statsScreen").classList.remove("hidden");
    renderStats();
}

// ---------- СТАТИСТИКА ----------
function renderStats() {
    const today = new Date().toISOString().split('T')[0];
    const oneWeekAgo = Date.now() - 7*24*60*60*1000;

    // 1. Today
    const todaySessions = sessions.filter(s => s.date === today);
    const todayMap = new Map();
    todaySessions.forEach(s => {
        const act = s.activity;
        const mins = s.duration / 60000;
        todayMap.set(act, (todayMap.get(act) || 0) + mins);
    });
    let todayHtml = '';
    for (let [act, mins] of todayMap) {
        todayHtml += `<tr><td>${act}</td><td>${Math.round(mins)} min</td></tr>`;
    }
    if (todayHtml === '') todayHtml = '<tr><td colspan="2">No activity today</td></tr>';
    document.getElementById('todayTable').innerHTML = todayHtml;

    // 2. Last 7 days by activity
    const weekSessions = sessions.filter(s => s.timestamp >= oneWeekAgo);
    const weekMap = new Map();
    weekSessions.forEach(s => {
        const act = s.activity;
        const mins = s.duration / 60000;
        weekMap.set(act, (weekMap.get(act) || 0) + mins);
    });
    let weekHtml = '';
    for (let [act, mins] of weekMap) {
        weekHtml += `<tr><td>${act}</td><td>${Math.round(mins)} min</td></tr>`;
    }
    if (weekHtml === '') weekHtml = '<tr><td colspan="2">No activity last 7 days</td></tr>';
    document.getElementById('weekActivityTable').innerHTML = weekHtml;

    // 3. Chart last 7 days (daily totals)
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date(Date.now() - i*24*60*60*1000);
        days.push(d.toISOString().split('T')[0]);
    }
    const dailyTotals = days.map(date => {
        const daySessions = sessions.filter(s => s.date === date);
        const totalMin = daySessions.reduce((acc, s) => acc + s.duration, 0) / 60000;
        return { date, totalMin };
    });
    const maxMin = Math.max(...dailyTotals.map(d => d.totalMin), 1);
    let chartHtml = '';
    dailyTotals.forEach(day => {
        const height = (day.totalMin / maxMin) * 120; // max 120px
        chartHtml += `
            <div class="chart-bar">
                <div class="bar" style="height: ${height}px;"></div>
                <div class="bar-label">${day.date.slice(5)}</div>
                <div class="bar-label">${Math.round(day.totalMin)} min</div>
            </div>
        `;
    });
    document.getElementById('weekChart').innerHTML = chartHtml;
}

// Инициализация
loadActivities();
renderStats();
</script>
</body>
</html>
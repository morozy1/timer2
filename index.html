<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>den ¬∑ —Ç–∞–π–º–µ—Ä + —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* --- —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–∞–∫ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏) --- */
*{margin:0;padding:0;box-sizing:border-box}
body{
min-height:100vh;display:flex;justify-content:center;align-items:center;
font-family:'Inter',sans-serif;color:white;
background:#1a1a1a;
padding:10px;
}
.top-nav{
position:fixed;
top:20px;
left:0;
right:0;
display:flex;
justify-content:center;
gap:20px;
z-index:1000;
}
.top-nav button{
background:#2d2d2d;
border:1px solid #404040;
padding:12px 32px;border-radius:40px;color:white;cursor:pointer;
font-weight:600;font-size:16px;transition:0.2s;
}
.top-nav button:hover{background:#404040;}
.top-nav button.active{
background:#a3e635;
color:#1a1a1a;
border-color:#a3e635;
}
.sound-toggle {
    background:#2d2d2d;
    border:1px solid #404040;
    padding:12px 20px;
    border-radius:40px;
    color:white;
    cursor:pointer;
    font-size:16px;
    display:inline-flex;
    align-items:center;
    gap:5px;
}
.sound-toggle i { font-size:18px; }

.goals-widget {
    position:fixed;
    top:80px;
    left:20px;
    background:#2d2d2d;
    border:1px solid #404040;
    border-radius:20px;
    padding:15px;
    width:240px;
    color:white;
    z-index:900;
    font-size:13px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.goals-widget h4 {
    margin-bottom:12px;
    color:#a3e635;
    font-size:14px;
    font-weight:600;
    text-align:center;
}
.goal-item {
    margin-bottom:12px;
}
.goal-item .goal-name {
    display:flex;
    justify-content:space-between;
    margin-bottom:3px;
}
.goal-item .goal-bar-bg {
    height:4px;
    background:#404040;
    border-radius:2px;
    overflow:hidden;
}
.goal-item .goal-bar-fill {
    height:100%;
    background:#a3e635;
    width:0%;
    transition:width 0.3s;
}
.no-goals {
    color:#b0b0b0;
    text-align:center;
    padding:5px;
}

.container{
width:100%;
max-width:1400px;
padding-top:90px;
margin:0 auto;
}
.card{
background:transparent;
border:none;
padding:40px 60px;
border-radius:48px;
display:flex;
flex-direction:column;
align-items:center;
gap:30px;
width:100%;
}
h2, h3{width:100%;font-weight:500;color:#e0e0e0;}
h2{font-size:24px;margin-bottom:5px;text-align:center;}
h3{font-size:18px;margin-bottom:10px;color:#b0b0b0;text-align:center;}
select,input,button{padding:12px 24px;border-radius:40px;border:none;outline:none;font-size:16px;}
.primary{
background:#a3e635;
color:#1a1a1a;
font-weight:600;
}
.primary:hover{background:#b8ff4d;}
.danger{background:#dc2626;color:white;}
.secondary{background:#404040;color:white;}
.secondary:hover{background:#525252;}
.hidden{display:none !important}

#currentActivity, #stopwatchCurrentActivity{
font-size:32px;font-weight:600;color:#a3e635;text-align:center;
}
#countdown, #stopwatchDisplay{
font-size:90px;text-align:center;font-weight:700;letter-spacing:5px;color:#a3e635;
}
.progress{height:10px;background:#404040;border-radius:20px;overflow:hidden;width:100%;}
.progress-bar{height:100%;width:0%;background:#a3e635;transition:width 1s linear;}
.activity-row{display:flex;gap:15px;flex-wrap:wrap;justify-content:center;}

.activity-btn{
background:#404040;color:white;padding:12px 24px;border-radius:40px;
cursor:pointer;transition:0.2s;border:2px solid transparent;
font-size:16px;
}
.activity-btn:hover{background:#525252;}
.activity-btn.active{
border-color:#a3e635;
background:#2d2d2d;
}

.picker-container{
display:flex;gap:60px;justify-content:center;align-items:center;
}
.picker{
display:flex;flex-direction:column;align-items:center;gap:10px;
}
.picker label{font-size:16px;color:#b0b0b0;text-transform:uppercase;letter-spacing:1px;}
.picker-value{
background:#404040;border-radius:40px;padding:20px 40px;
font-size:48px;font-weight:700;color:#a3e635;
cursor:ns-resize;user-select:none;transition:0.1s;
border:2px solid transparent;
}
.picker-value:hover{border-color:#a3e635;}

.add-category{
display:flex;gap:15px;width:100%;justify-content:center;flex-wrap:wrap;
}
.add-category input{
width:250px;background:#404040;color:white;padding:12px 20px;
}
.add-category input::placeholder{color:#b0b0b0;}

.stats-grid{
display:flex;flex-direction:column;gap:30px;width:100%;
}
.stats-card{
background:#404040;border-radius:30px;padding:30px;
}
.stats-card h3{margin-bottom:15px;color:#e0e0e0;text-align:left; font-size:20px;}
.stats-table{width:100%;border-collapse:collapse;}
.stats-table td{padding:12px 0;border-bottom:1px solid #525252;}
.stats-table tr:last-child td{border-bottom:none;}
.chart-container{
width:100%;height:300px;margin-top:15px;
}

.skeleton {
    background: linear-gradient(90deg, #404040 25%, #525252 50%, #404040 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 20px;
}
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
.skeleton-table td { height: 24px; background:#404040; border-radius:8px; }
.skeleton-chart { width:100%; height:300px; background:#404040; border-radius:20px; }

.stats-filters {
    display:flex;gap:15px;flex-wrap:wrap;justify-content:center;margin-bottom:25px;
}
.stats-filters select,
.stats-filters input[type="date"],
.stats-filters button {
    background:#404040;color:white;padding:12px 20px;border-radius:40px;border:1px solid #525252;font-size:15px;cursor:pointer;
}
.stats-filters select:hover,
.stats-filters input[type="date"]:hover,
.stats-filters button:hover {
    background:#525252;
}
.stats-filters select option {
    background:#2d2d2d;color:white;
}
.date-range {
    display:flex;gap:5px;align-items:center;flex-wrap:wrap;
}

@media (min-width: 1600px) {
    .container { max-width: 1600px; }
    .card { padding: 50px 80px; }
    #countdown, #stopwatchDisplay { font-size: 110px; }
    .picker-value { font-size: 56px; padding: 25px 50px; }
    .activity-btn { padding: 14px 30px; font-size: 18px; }
}
</style>
</head>
<body>

<!-- –í–∏–¥–∂–µ—Ç —Ü–µ–ª–µ–π -->
<div class="goals-widget" id="goalsWidget">
    <h4>Daily Goals</h4>
    <div id="goalsList"></div>
</div>

<div class="container">

<div class="top-nav">
<button id="timerNavBtn" onclick="showTimer()">Timer</button>
<button id="stopwatchNavBtn" onclick="showStopwatch()">Stopwatch</button>
<button id="statsNavBtn" onclick="showStats()">Statistics</button>
<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∑–≤—É–∫–∞ -->
<div class="sound-toggle" onclick="toggleSound()" id="soundToggle">
    <i class="fas fa-volume-up"></i>
</div>
</div>

<!-- TIMER -->
<div id="timerScreen">
<div class="card">

    <div id="activitySelection" style="width:100%;">
        <h3>Activity</h3>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div id="activityButtons" class="activity-row" style="justify-content: center;"></div>
            <div class="add-category">
                <input type="text" id="newCategoryInput" placeholder="New category">
                <button class="secondary" onclick="addCategory()">Add</button>
                <button class="danger" onclick="deleteCategory()">Delete</button>
            </div>
        </div>
    </div>

    <div id="quickButtons" style="width:100%;">
        <h3>Quick select</h3>
        <div class="activity-row">
            <button class="secondary" onclick="startQuick(15)">15 min</button>
            <button class="secondary" onclick="startQuick(30)">30 min</button>
            <button class="secondary" onclick="startQuick(60)">1 hour</button>
            <button class="secondary" onclick="startQuick(120)">2 hours</button>
        </div>
    </div>

    <div id="customPicker" style="width:100%;">
        <h3>Custom time</h3>
        <div class="picker-container">
            <div class="picker">
                <label>Hours</label>
                <div class="picker-value" id="hoursValue">0</div>
            </div>
            <div class="picker">
                <label>Minutes</label>
                <div class="picker-value" id="minutesValue">0</div>
            </div>
        </div>
        <div class="activity-row" style="margin-top:20px;">
            <button class="primary" onclick="startCustom()">Start Session</button>
        </div>
    </div>

    <div id="timerActiveArea" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center; gap:15px;">
        <div id="currentActivity"></div>
        <div id="countdown">00:00</div>
        <div class="progress" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="runningButtons" class="activity-row">
            <button class="secondary" onclick="finishEarly()">Finish Early</button>
            <button class="danger" onclick="cancelTimer()">Cancel</button>
        </div>
    </div>

</div>
</div>

<!-- STOPWATCH -->
<div id="stopwatchScreen" class="hidden">
<div class="card">

    <h3>Stopwatch</h3>

    <div id="stopwatchActivitySection" style="width:100%;">
        <div id="stopwatchActivityButtons" class="activity-row" style="justify-content: center; margin-bottom:10px;"></div>
    </div>

    <div id="stopwatchCurrentActivity" class="hidden"></div>
    <div id="stopwatchDisplay">00:00:00</div>

    <div id="stopwatchStartControls" class="activity-row" style="margin-top:10px;">
        <button class="primary" onclick="startStopwatch()">Start</button>
    </div>

    <div id="stopwatchActiveControls" class="activity-row hidden" style="margin-top:10px;">
        <button class="secondary" onclick="togglePause()" id="stopwatchPauseBtn">Pause</button>
        <button class="danger" onclick="resetStopwatch()">Reset</button>
        <button class="secondary" onclick="saveStopwatchSession()">Save & Reset</button>
    </div>

</div>
</div>

<!-- STATISTICS -->
<div id="statsScreen" class="hidden">
<div class="card">
    <h2>Statistics</h2>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="stats-filters">
        <select id="filterActivity">
            <option value="all">All activities</option>
        </select>
        <select id="filterPeriod">
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="custom">Custom range</option>
        </select>
        <div class="date-range" id="customDateRange" style="display:none;">
            <input type="date" id="startDate">
            <span>-</span>
            <input type="date" id="endDate">
        </div>
        <button class="secondary" onclick="applyStatsFilter()">Apply</button>
    </div>

    <!-- –°–∫–µ–ª–µ—Ç–æ–Ω—ã -->
    <div id="statsSkeleton" class="stats-grid">
        <div class="stats-card skeleton" style="height:200px;"></div>
        <div class="stats-card skeleton" style="height:200px;"></div>
        <div class="stats-card skeleton-chart" style="height:300px;"></div>
    </div>

    <!-- –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
    <div id="statsContent" class="stats-grid hidden">
        <div class="stats-card" id="todayStats">
            <h3>Today</h3>
            <table class="stats-table" id="todayTable"></table>
        </div>
        <div class="stats-card" id="weekActivityStats">
            <h3>Selected period (by activity)</h3>
            <table class="stats-table" id="periodTable"></table>
        </div>
        <div class="stats-card" id="weekChartStats">
            <h3>Activity trends</h3>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>
</div>
</div>

</div>

<script>
// ---------- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ----------
let activities = JSON.parse(localStorage.getItem("activities")) || ["General"];
let sessions = JSON.parse(localStorage.getItem("sessions")) || [];
let goals = JSON.parse(localStorage.getItem("goals")) || {};

let targetDate, startTime, interval, totalDuration;
let selectedActivity = "General";

let stopwatchInterval = null;
let stopwatchStartTime = null;
let stopwatchPausedTime = 0;
let stopwatchRunning = false;
let selectedStopwatchActivity = "General";

const hoursDiv = document.getElementById("hoursValue");
const minutesDiv = document.getElementById("minutesValue");
const activityButtonsDiv = document.getElementById("activityButtons");
const stopwatchActivityButtonsDiv = document.getElementById("stopwatchActivityButtons");
const timerNavBtn = document.getElementById("timerNavBtn");
const stopwatchNavBtn = document.getElementById("stopwatchNavBtn");
const statsNavBtn = document.getElementById("statsNavBtn");

const stopwatchActivitySection = document.getElementById("stopwatchActivitySection");
const stopwatchCurrentActivity = document.getElementById("stopwatchCurrentActivity");
const stopwatchStartControls = document.getElementById("stopwatchStartControls");
const stopwatchActiveControls = document.getElementById("stopwatchActiveControls");
const stopwatchPauseBtn = document.getElementById("stopwatchPauseBtn");

const filterActivity = document.getElementById("filterActivity");
const filterPeriod = document.getElementById("filterPeriod");
const customDateRange = document.getElementById("customDateRange");
const startDate = document.getElementById("startDate");
const endDate = document.getElementById("endDate");
const statsSkeleton = document.getElementById("statsSkeleton");
const statsContent = document.getElementById("statsContent");

let hours = 0, minutes = 0;
let chartInstance = null;

// ---------- –ó–í–£–ö (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π base64) ----------
let soundEnabled = true;
const soundToggle = document.getElementById("soundToggle");

// –ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª (Data URI) ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π –ø–∏—Å–∫
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let audioAllowed = false; // —Ñ–ª–∞–≥, —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

// –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞—É–¥–∏–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
function enableAudio() {
    if (!audioAllowed) {
        audioCtx.resume().then(() => {
            audioAllowed = true;
            console.log("Audio unlocked");
        });
    }
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∫–æ—Ä–æ—Ç–∫–∏–π —Å–∏–≥–Ω–∞–ª —á–µ—Ä–µ–∑ Web Audio API
function playBeep() {
    if (!soundEnabled) return;
    if (!audioAllowed) {
        console.warn("Audio not yet allowed, click sound icon to enable");
        return;
    }
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = 880; // –Ω–æ—Ç–∞ –õ—è
    gain.gain.setValueAtTime(0.1, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
    osc.start(now);
    osc.stop(now + 0.2);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–≤—É–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
function toggleSound() {
    soundEnabled = !soundEnabled;
    soundToggle.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
    enableAudio(); // –ø—Ä–∏ –ª—é–±–æ–º –∫–ª–∏–∫–µ –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ
    if (soundEnabled) {
        // –ø—Ä–æ–±–Ω—ã–π –∑–≤—É–∫, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
        playBeep();
    }
}

// –í—ã–∑—ã–≤–∞–µ–º playBeep –≤–µ–∑–¥–µ, –≥–¥–µ —Ä–∞–Ω—å—à–µ –±—ã–ª playSound
function playSound() {
    playBeep();
}

function setActiveNav(activeId) {
    [timerNavBtn, stopwatchNavBtn, statsNavBtn].forEach(btn => btn.classList.remove("active"));
    document.getElementById(activeId).classList.add("active");
}

// ---------- –°–û–•–†–ê–ù–ï–ù–ò–ï –¢–ê–ô–ú–ï–†–ê ----------
function saveTimerState() {
    if (targetDate) {
        const state = {
            targetDate: targetDate.getTime(),
            totalDuration: totalDuration,
            selectedActivity: selectedActivity,
            startTime: startTime ? startTime.getTime() : null
        };
        localStorage.setItem("timerState", JSON.stringify(state));
    }
}

function clearTimerState() {
    localStorage.removeItem("timerState");
}

function restoreTimerState() {
    const saved = localStorage.getItem("timerState");
    if (!saved) return false;
    try {
        const state = JSON.parse(saved);
        const now = Date.now();
        if (state.targetDate > now) {
            targetDate = new Date(state.targetDate);
            totalDuration = state.totalDuration;
            selectedActivity = state.selectedActivity;
            startTime = state.startTime ? new Date(state.startTime) : new Date(now - (totalDuration - (targetDate - now)));
            loadActivities();
            showTimer();
            launch(true);
            return true;
        } else {
            completeSession(state.totalDuration);
            clearTimerState();
            return false;
        }
    } catch (e) {
        console.error("Failed to restore timer state", e);
        clearTimerState();
        return false;
    }
}

function saveActivities() { localStorage.setItem("activities", JSON.stringify(activities)); }
function saveSessions() { localStorage.setItem("sessions", JSON.stringify(sessions)); }
function saveGoals() { localStorage.setItem("goals", JSON.stringify(goals)); }

// ---------- –ó–ê–ì–†–£–ó–ö–ê –ê–ö–¢–ò–í–ù–û–°–¢–ï–ô ----------
function loadActivities() {
    activityButtonsDiv.innerHTML = "";
    activities.forEach(act => {
        let btn = document.createElement("button");
        btn.className = "activity-btn";
        if (act === selectedActivity) btn.classList.add("active");
        btn.textContent = act;
        btn.onclick = () => {
            selectedActivity = act;
            document.querySelectorAll("#activityButtons .activity-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        };
        activityButtonsDiv.appendChild(btn);
    });

    stopwatchActivityButtonsDiv.innerHTML = "";
    activities.forEach(act => {
        let btn = document.createElement("button");
        btn.className = "activity-btn";
        if (act === selectedStopwatchActivity) btn.classList.add("active");
        btn.textContent = act;
        btn.onclick = () => {
            selectedStopwatchActivity = act;
            document.querySelectorAll("#stopwatchActivityButtons .activity-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        };
        stopwatchActivityButtonsDiv.appendChild(btn);
    });

    filterActivity.innerHTML = '<option value="all">All activities</option>';
    activities.forEach(act => {
        let opt = document.createElement("option");
        opt.value = act;
        opt.textContent = act;
        filterActivity.appendChild(opt);
    });

    renderGoalsWidget(); // –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç —Ü–µ–ª–µ–π
}

// ---------- –í–ò–î–ñ–ï–¢ –¶–ï–õ–ï–ô ----------
function renderGoalsWidget() {
    const list = document.getElementById("goalsList");
    if (!list) return;
    const today = new Date().toISOString().split('T')[0];
    let html = '';
    activities.forEach(act => {
        const goal = goals[act] || 0;
        if (goal > 0) {
            const todayTotal = sessions.filter(s => s.activity === act && s.date === today).reduce((acc, s) => acc + s.duration, 0) / 60000;
            const percent = Math.min((todayTotal / goal) * 100, 100);
            html += `
                <div class="goal-item">
                    <div class="goal-name">
                        <span>${act}</span>
                        <span>${Math.round(todayTotal)}/${goal} min</span>
                    </div>
                    <div class="goal-bar-bg"><div class="goal-bar-fill" style="width: ${percent}%;"></div></div>
                </div>
            `;
        }
    });
    if (html === '') {
        html = '<div class="no-goals">No goals set</div>';
    }
    list.innerHTML = html;
}

function setGoal(activity) {
    const newGoal = prompt(`Set daily goal (minutes) for ${activity}:`, goals[activity] || 0);
    if (newGoal !== null && !isNaN(newGoal) && newGoal >= 0) {
        goals[activity] = parseInt(newGoal);
        saveGoals();
        renderGoalsWidget();
        renderStats(); // –æ–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    }
}

function addCategory() {
    const input = document.getElementById("newCategoryInput");
    const name = input.value.trim();
    if (!name) return;
    if (!activities.includes(name)) {
        activities.push(name);
        saveActivities();
        loadActivities();
        input.value = "";
    } else alert("Category already exists");
}

function deleteCategory() {
    if (selectedActivity === "General") { alert("General cannot be deleted."); return; }
    activities = activities.filter(a => a !== selectedActivity);
    delete goals[selectedActivity];
    saveActivities();
    saveGoals();
    if (!activities.includes(selectedActivity)) selectedActivity = "General";
    if (!activities.includes(selectedStopwatchActivity)) selectedStopwatchActivity = "General";
    loadActivities();
}

// ---------- –¢–ê–ô–ú–ï–† ----------
function setupWheel(element, min, max, callback) {
    element.addEventListener('wheel', (e) => {
        e.preventDefault();
        let delta = e.deltaY > 0 ? -1 : 1;
        let newVal = parseInt(element.innerText) + delta;
        if (newVal < min) newVal = max;
        if (newVal > max) newVal = min;
        element.innerText = newVal;
        callback(newVal);
    });
}
setupWheel(hoursDiv, 0, 23, (val) => hours = val);
setupWheel(minutesDiv, 0, 59, (val) => minutes = val);

function startQuick(minutesTotal) {
    startTimerWithMinutes(minutesTotal);
}
function startCustom() {
    let totalMinutes = hours * 60 + minutes;
    if (totalMinutes <= 0) { alert("Select time > 0"); return; }
    startTimerWithMinutes(totalMinutes);
}
function startTimerWithMinutes(minutes) {
    clearInterval(interval);
    const now = new Date();
    startTime = now;
    targetDate = new Date(now.getTime() + minutes * 60000);
    totalDuration = targetDate - now;
    launch();
    saveTimerState();
}
function launch(isRestore = false) {
    document.getElementById("activitySelection").classList.add("hidden");
    document.getElementById("quickButtons").classList.add("hidden");
    document.getElementById("customPicker").classList.add("hidden");
    const timerArea = document.getElementById("timerActiveArea");
    timerArea.classList.remove("hidden");
    document.getElementById("currentActivity").textContent = selectedActivity;
    if (!isRestore) {
        update();
        interval = setInterval(update, 1000);
    } else {
        update();
        interval = setInterval(update, 1000);
    }
}
function update() {
    const now = new Date();
    const diff = targetDate - now;
    if (diff <= 0) { completeSession(totalDuration); return; }
    const percent = ((totalDuration - diff) / totalDuration) * 100;
    document.getElementById("progressBar").style.width = percent + "%";
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    document.getElementById("countdown").textContent =
        String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');
    saveTimerState();
}
function completeSession(duration) {
    clearInterval(interval);
    const activity = selectedActivity;
    sessions.push({
        activity: activity,
        duration: duration,
        date: new Date().toISOString().split("T")[0],
        timestamp: Date.now()
    });
    saveSessions();
    clearTimerState();
    resetUI();
    playSound();
    renderGoalsWidget(); // –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç
    renderStats();
}
function finishEarly() {
    clearInterval(interval);
    const duration = new Date() - startTime;
    completeSession(duration);
}
function cancelTimer() {
    clearInterval(interval);
    clearTimerState();
    resetUI();
}
function resetUI() {
    document.getElementById("activitySelection").classList.remove("hidden");
    document.getElementById("quickButtons").classList.remove("hidden");
    document.getElementById("customPicker").classList.remove("hidden");
    document.getElementById("timerActiveArea").classList.add("hidden");
    document.getElementById("progressBar").style.width = "0%";
    document.getElementById("countdown").textContent = "00:00";
}

// ---------- –°–ï–ö–£–ù–î–û–ú–ï–† ----------
function formatStopwatchTime(ms) {
    let totalSeconds = Math.floor(ms / 1000);
    let hours = Math.floor(totalSeconds / 3600);
    let minutes = Math.floor((totalSeconds % 3600) / 60);
    let seconds = totalSeconds % 60;
    return String(hours).padStart(2,'0') + ':' + String(minutes).padStart(2,'0') + ':' + String(seconds).padStart(2,'0');
}
function updateStopwatchDisplay() {
    if (!stopwatchRunning && stopwatchPausedTime === 0) {
        document.getElementById("stopwatchDisplay").textContent = "00:00:00";
        return;
    }
    let now = Date.now();
    let elapsed = stopwatchPausedTime;
    if (stopwatchRunning) elapsed += (now - stopwatchStartTime);
    document.getElementById("stopwatchDisplay").textContent = formatStopwatchTime(elapsed);
}
function updateStopwatchUI() {
    const hasTime = stopwatchPausedTime > 0 || stopwatchRunning;
    if (hasTime) {
        stopwatchActivitySection.classList.add("hidden");
        stopwatchCurrentActivity.classList.remove("hidden");
        stopwatchCurrentActivity.textContent = selectedStopwatchActivity;
        stopwatchStartControls.classList.add("hidden");
        stopwatchActiveControls.classList.remove("hidden");
        stopwatchPauseBtn.textContent = stopwatchRunning ? "Pause" : "Continue";
    } else {
        stopwatchActivitySection.classList.remove("hidden");
        stopwatchCurrentActivity.classList.add("hidden");
        stopwatchStartControls.classList.remove("hidden");
        stopwatchActiveControls.classList.add("hidden");
    }
}
function startStopwatch() {
    if (stopwatchRunning) return;
    if (stopwatchPausedTime > 0) stopwatchStartTime = Date.now();
    else { stopwatchStartTime = Date.now(); stopwatchPausedTime = 0; }
    stopwatchRunning = true;
    if (stopwatchInterval) clearInterval(stopwatchInterval);
    stopwatchInterval = setInterval(() => {
        updateStopwatchDisplay();
        updateStopwatchUI();
    }, 100);
    updateStopwatchUI();
}
function pauseStopwatch() {
    if (!stopwatchRunning) return;
    let now = Date.now();
    stopwatchPausedTime += (now - stopwatchStartTime);
    stopwatchRunning = false;
    clearInterval(stopwatchInterval); stopwatchInterval = null;
    updateStopwatchDisplay(); updateStopwatchUI();
}
function togglePause() {
    if (stopwatchRunning) pauseStopwatch();
    else if (stopwatchPausedTime > 0) startStopwatch();
}
function resetStopwatch() {
    pauseStopwatch(); stopwatchPausedTime = 0; stopwatchRunning = false;
    updateStopwatchDisplay(); updateStopwatchUI();
}
function saveStopwatchSession() {
    if (stopwatchPausedTime === 0 && !stopwatchRunning) { alert("No time measured"); return; }
    let finalElapsed = stopwatchPausedTime;
    if (stopwatchRunning) {
        let now = Date.now(); finalElapsed += (now - stopwatchStartTime); pauseStopwatch();
    }
    sessions.push({
        activity: selectedStopwatchActivity,
        duration: finalElapsed,
        date: new Date().toISOString().split("T")[0],
        timestamp: Date.now()
    });
    saveSessions();
    resetStopwatch();
    playSound();
    renderGoalsWidget();
    renderStats();
    // –£–±—Ä–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
}

// ---------- –ù–ê–í–ò–ì–ê–¶–ò–Ø ----------
function showTimer() {
    setActiveNav("timerNavBtn");
    document.getElementById("timerScreen").classList.remove("hidden");
    document.getElementById("stopwatchScreen").classList.add("hidden");
    document.getElementById("statsScreen").classList.add("hidden");
}
function showStopwatch() {
    setActiveNav("stopwatchNavBtn");
    document.getElementById("timerScreen").classList.add("hidden");
    document.getElementById("stopwatchScreen").classList.remove("hidden");
    document.getElementById("statsScreen").classList.add("hidden");
    updateStopwatchDisplay(); updateStopwatchUI();
}
function showStats() {
    setActiveNav("statsNavBtn");
    document.getElementById("timerScreen").classList.add("hidden");
    document.getElementById("stopwatchScreen").classList.add("hidden");
    document.getElementById("statsScreen").classList.remove("hidden");
    statsSkeleton.classList.remove("hidden"); statsContent.classList.add("hidden");
    setTimeout(() => {
        renderStats();
        statsSkeleton.classList.add("hidden");
        statsContent.classList.remove("hidden");
    }, 200);
}

// ---------- –§–ò–õ–¨–¢–†–´ ----------
let currentFilter = { activity: 'all', period: '7', start: null, end: null };
filterPeriod.addEventListener('change', () => {
    customDateRange.style.display = filterPeriod.value === 'custom' ? 'flex' : 'none';
});
function applyStatsFilter() {
    currentFilter.activity = filterActivity.value;
    currentFilter.period = filterPeriod.value;
    if (currentFilter.period === 'custom') {
        currentFilter.start = startDate.value;
        currentFilter.end = endDate.value;
        if (!currentFilter.start || !currentFilter.end) { alert("Select both dates"); return; }
    }
    showStats(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç —Å–æ —Å–∫–µ–ª–µ—Ç–æ–Ω–æ–º
}

// ---------- –°–¢–ê–¢–ò–°–¢–ò–ö–ê ----------
function renderStats() {
    const today = new Date().toISOString().split('T')[0];
    let filteredSessions = sessions;
    if (currentFilter.activity !== 'all') filteredSessions = filteredSessions.filter(s => s.activity === currentFilter.activity);

    let start, end;
    if (currentFilter.period === '7') { end = Date.now(); start = end - 7*24*60*60*1000; }
    else if (currentFilter.period === '30') { end = Date.now(); start = end - 30*24*60*60*1000; }
    else if (currentFilter.period === 'custom') {
        start = new Date(currentFilter.start).getTime();
        end = new Date(currentFilter.end).getTime() + 24*60*60*1000 - 1;
    }
    if (start && end) filteredSessions = filteredSessions.filter(s => s.timestamp >= start && s.timestamp <= end);

    // Today
    const todaySessions = sessions.filter(s => s.date === today);
    const todayMap = new Map();
    todaySessions.forEach(s => {
        const mins = s.duration / 60000;
        todayMap.set(s.activity, (todayMap.get(s.activity) || 0) + mins);
    });
    let todayHtml = '';
    for (let [act, mins] of todayMap) {
        todayHtml += `<tr><td>${act} ${goals[act] ? 'üéØ' + goals[act] : ''}</td><td>${Math.round(mins)} min</td></tr>`;
    }
    if (todayHtml === '') todayHtml = '<tr><td colspan="2">No activity today</td></tr>';
    document.getElementById('todayTable').innerHTML = todayHtml;

    // Period by activity
    const periodMap = new Map();
    filteredSessions.forEach(s => {
        const mins = s.duration / 60000;
        periodMap.set(s.activity, (periodMap.get(s.activity) || 0) + mins);
    });
    let periodHtml = '';
    for (let [act, mins] of periodMap) {
        periodHtml += `<tr><td>${act} ${goals[act] ? 'üéØ' + goals[act] : ''} <button class="secondary" style="padding:2px 5px; font-size:10px;" onclick="setGoal('${act}')">set goal</button></td><td>${Math.round(mins)} min</td></tr>`;
    }
    if (periodHtml === '') periodHtml = '<tr><td colspan="2">No activity in selected period</td></tr>';
    document.getElementById('periodTable').innerHTML = periodHtml;

    // Chart
    const days = [];
    if (currentFilter.period === '7' || currentFilter.period === '30') {
        let numDays = currentFilter.period === '7' ? 7 : 30;
        for (let i = numDays-1; i >= 0; i--) {
            days.push(new Date(Date.now() - i*24*60*60*1000).toISOString().split('T')[0]);
        }
    } else if (currentFilter.period === 'custom' && start && end) {
        let cur = new Date(start);
        let last = new Date(end);
        while (cur <= last) {
            days.push(cur.toISOString().split('T')[0]);
            cur.setDate(cur.getDate() + 1);
        }
    }
    const uniqueActivities = [...new Set(filteredSessions.map(s => s.activity))];
    if (uniqueActivities.length === 0) {
        if (chartInstance) chartInstance.destroy();
        const ctx = document.getElementById('activityChart').getContext('2d');
        chartInstance = new Chart(ctx, { type: 'line', data: { labels: days.map(d => d.slice(5)), datasets: [] }, options: { responsive: true, maintainAspectRatio: false } });
        return;
    }
    const datasets = [];
    const colors = ['#a3e635', '#60a5fa', '#f87171', '#fbbf24', '#c084fc', '#34d399', '#f472b6'];
    uniqueActivities.forEach((act, idx) => {
        const data = days.map(date => {
            const daySessions = filteredSessions.filter(s => s.date === date && s.activity === act);
            return Math.round(daySessions.reduce((acc, s) => acc + s.duration, 0) / 60000 * 10) / 10;
        });
        datasets.push({
            label: act,
            data: data,
            borderColor: colors[idx % colors.length],
            backgroundColor: 'transparent',
            tension: 0.3,
            pointBackgroundColor: colors[idx % colors.length],
            borderWidth: 3
        });
    });
    if (chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('activityChart').getContext('2d');
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels: days.map(d => d.slice(5)), datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'minutes', color: '#b0b0b0' }, ticks: { color: '#b0b0b0' }, grid: { color: '#404040' } },
                x: { ticks: { color: '#b0b0b0' }, grid: { color: '#404040' } }
            },
            plugins: { legend: { labels: { color: '#e0e0e0', usePointStyle: true, pointStyle: 'circle', boxWidth: 4, boxHeight: 4, font: { size: 10 } } } }
        }
    });
}

// ---------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ----------
loadActivities();
renderStats();
if (!restoreTimerState()) resetUI();
setActiveNav("timerNavBtn");

// –ü—Ä–∏ –ª—é–±–æ–º –∫–ª–∏–∫–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—ã—Ç–∞–µ–º—Å—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
document.addEventListener('click', enableAudio, { once: true });
</script>
</body>
</html>
